DROP TABLE IF EXISTS tag_to_record;

DROP TABLE IF EXISTS tags;

CREATE TABLE tags (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name TEXT NOT NULL
);

CREATE TABLE tag_to_record (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    tag_id BIGINT NOT NULL REFERENCES tags,
    record_id BIGINT NOT NULL REFERENCES records
);

INSERT INTO
    tags (name)
VALUES
    ('задачи'),
    ('дневник'),
    ('рецепты'),
    ('цитаты'),
    ('идеи');

WITH
    new_records AS (
        INSERT INTO
            records (user_id, content)
        SELECT
            users.id,
            t.content
        FROM
            users,
            (
                VALUES
                    ('Написать приложение "Дневник" на Go'),
                    ('Похудеть до 68 кг')
            ) AS t (content)
        WHERE
            login LIKE 'nikita'
        RETURNING
            id
    )
INSERT INTO
    tag_to_record (tag_id, record_id)
SELECT
    tags.id,
    new_records.id
FROM
    tags,
    new_records
WHERE
    tags.name IN ('задачи', 'идеи');

SELECT
    user_id,
    content,
    STRING_AGG(name, ',') AS tags
FROM
    records
    JOIN tag_to_record ON records.id = record_id
    JOIN tags ON tags.id = tag_id
GROUP BY
    user_id,
    content;